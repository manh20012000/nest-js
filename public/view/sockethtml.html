<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat with NestJS Socket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f0f0f0;
    }

    .container {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 300px;
      max-height: 500px;
      overflow-y: auto;
    }

    .user-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: pink;
      padding: 10px;
      border-radius: 8px;
    }

    .user-header img {
      border-radius: 50%;
      width: 50px;
      height: 50px;
    }

    .user-list {
      margin-top: 20px;
    }

    .user-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 5px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s;
      position: relative;
    }

    .user-item img {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      margin-right: 10px;
    }

    .user-item:hover {
      background-color: #f0f0f0;
    }

    .user-item .status {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background-color: grey;
      position: absolute;
      bottom: 5px;
      right: 5px;
      z-index: 1;
    }

    .user-item.online .status {
      background-color: green;
    }
  </style>
</head>

<body>
  <div style="width: 100%; height: 100%">
    <div style="
          background-color: pink;
          width: 30%;
          height: 10%;
          display: flex;
          justify-content: space-between;
        ">
      <h5 id="name"></h5>
      <div style="
            border-radius: 100%;
            width: 10%;
            height: 100%;
            background-color: green;
          ">
        <img class="profile-image" id="avatar" src="" style="width: 100%; height: 100%" />
      </div>
    </div>
    <div class="user-list" id="userList"></div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="./socket.js"></script>
  <script>

    const userJson = localStorage.getItem('InforUser');
    if (userJson) {
      const user = JSON.parse(userJson);
      console.log(user, 'dhsdh log user')
      const iduser = user.id;
      document.getElementById('name').textContent = user.name;
      document.getElementById('avatar').src = user.avatar;
    }

    fetch('http://localhost:8080/auth/getUser', {
      method: 'GET',
      headers: {
        Authorization: token,
        'Refresh-Token': refreshtoken,
        'Content-Type': 'application/json',
      },
    })
      .then((response) => response.json())
      .then((users) => {
        const userListContainer = document.getElementById('userList');
        users.forEach((user) => {
          const userItem = document.createElement('div');
          userItem.classList.add('user-item');
          userItem.setAttribute('data-user-id', user._id);
          userItem.innerHTML = `<img src="${user.avatar}" alt="${user.name} Avatar"> <span>${user.name}</span><div class="status"></div>`;
          userListContainer.appendChild(userItem);

          // Xử lý khi người dùng click vào một người dùng trong danh sách
          userItem.addEventListener('click', () => {
            const userJson = encodeURIComponent(JSON.stringify(user));
            window.location.href = `Chat.html?user=${userJson}`;
          });
        });


        // Kết nối Socket.IO và xử lý sự kiện 'UserOnline'

        appSocket.socket.on('newAccessToken', (newToken) => {
          console.log('Received new access token:', newToken);
          localStorage.setItem('accessToken', newToken);

          appSocket.socket.io.opts.query.token = newToken;
          appSocket.socket.connect();
        });

        appSocket.socket.on("server-send-when-has-user-online", (onlineUserIds) => {
          console.log(onlineUserIds, 'giá trị user được log ra');

          // Cập nhật trạng thái người dùng
          const userItems = document.querySelectorAll('.user-item');
          userItems.forEach((item) => {
            const userId = item.getAttribute('data-user-id');
            const statusElement = item.querySelector('.status');

            if (onlineUserIds.includes(userId)) {
              item.classList.add('online');
            } else {
              item.classList.remove('online');
            }
          });
        });
        appSocket.socket.on("user-online", (onlineUserIds) => {
          console.log(onlineUserIds, 'giá trị user được log ra');

          // Cập nhật trạng thái người dùng
          const userItems = document.querySelectorAll('.user-item');
          userItems.forEach((item) => {
            const userId = item.getAttribute('data-user-id');
            const statusElement = item.querySelector('.status');

            if (onlineUserIds.includes(userId)) {
              item.classList.add('online');
            } else {
              item.classList.remove('online');
            }
          });
        });
      })

  </script>
</body>

</html>

<!-- /* const newuser = {
                avatar:user.avatar
                  ,
                birthdate:user.birthdate,
               
                email:user.email,
                gender:user.gender,
                name: user.name,
                nameaccount: user.nameaccount,
                phonenumber: user.phonenumber,
                surname: user.surname,
              };*/ -->